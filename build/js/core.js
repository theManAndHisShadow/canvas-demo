(()=>{"use strict";class e{#e={};#t=[];constructor(){}subscribe(e){this.#t.push(e)}setState(e,t){let n=this.#e[e];this.#e[e]=t,this.#t.forEach((s=>s(e,t,n)))}getState(e){return this.#e[e]}}class t{constructor(){this.events={}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}dispatchEvent(e,t){this.events[e]&&this.events[e].forEach((e=>e(t)))}}class n extends t{constructor({display:t,controls:n,timestamp:i}){super(),this.currentSceneTimestamp=i,this.states=new e,this.display=new r(t),this.controls=new s(n,this)}render(e){if(e){this.display.clearRoot(),this.controls.clearRoot();let t=[...Object.keys(e)];for(;t.length>0;){let n=t.shift(),s=e[n];"display-item"==s.type&&this.display.renderDisplayItem(n,s),"display-float-tile"==s.type&&this.display.renderDisplayFloatTile(n,s),"display-spacer"==s.type&&this.display.renderSpacer(),"display-infobox"==s.type&&this.display.renderInfoBox(n,s),"range-slider"==s.type&&this.controls.renderRangeSlider(n,s),"main-action-button"==s.type&&this.controls.renderMainActionButton(n,s),"button"==s.type&&this.controls.renderButton(n,s),"checkbox"==s.type&&this.controls.renderCheckbox(n,s),"input"==s.type&&this.controls.renderInput(n,s),"option-selector"==s.type&&this.controls.renderOptionSelector(n,s),"option-dropdown-list"==s.type&&this.controls.renderOptionDropdownList(n,s),"preset-dropdown-list"==s.type&&this.controls.renderPresetDropdownList(n,s),0==t.length&&this.dispatchEvent("renderEnd")}}}}class s{#n;#s="data-rendered-control-element";#r="data-main-action-button";constructor(e,t){this.parent=t,this.#n={root:e},this.currentSceneTimestamp=this.parent.currentSceneTimestamp,this.blockedSceneTimestamp=!1}clearRoot(){this.#n.root.innerHTML=""}appendToHTML(e,t){let{element:n,label:s,value:r}=t;this.#n[e]=t,this.#n.root.appendChild(n)}#i(e){let t=e,n=this;return{block(){n.blockedSceneTimestamp=t,Array.from(n.#n.root.querySelectorAll(`[${n.#s}]`)).forEach((e=>{e.getAttribute(n.#s)==t&&("INPUT"==e.tagName?e.setAttribute("disabled",""):e.classList.add("disabled"))}))},unblock(){n.blockedSceneTimestamp=0,Array.from(n.#n.root.querySelectorAll(`[${n.#s}]`)).forEach((e=>{e.getAttribute(n.#s)==t&&("INPUT"==e.tagName?e.removeAttribute("disabled"):e.classList.remove("disabled"))}))}}}renderCheckbox(e,t){let n=document.createElement("div");n.id=e;let s=document.createElement("span");s.innerText=t.label+": ",s.classList.add("controls__checkbox-label","controls__option-label");let r=document.createElement("input");r.type="checkbox",r.classList.add("controls__checkbox-checkbox"),r.checked=t.state,r.setAttribute(this.#s,this.currentSceneTimestamp),this.parent.states.setState(e,t.state),r.addEventListener("click",(t=>{this.blockedSceneTimestamp!==this.currentSceneTimestamp&&this.parent.states.setState(e,r.checked)})),n.appendChild(s),n.appendChild(r),this.appendToHTML(e,{element:n,label:s,value:r})}renderInput(e,t){t.minValue="number"==typeof t.minValue?t.minValue:t.defaultValue;let n=document.createElement("div");n.id=e;let s=document.createElement("span");s.classList.add("controls__input-label","controls__option-label"),s.innerText=t.label+": ";let r=document.createElement("input");r.classList.add("controls__input-input"),r.type="number",r.min=t.minValue,r.max=t.maxValue,r.placeholder="max "+t.maxValue,r.setAttribute(this.#s,this.currentSceneTimestamp),r.value=t.defaultValue,this.parent.states.setState(e,t.defaultValue),r.addEventListener("change",(n=>{Number(r.value)>t.maxValue&&(r.value=t.maxValue),Number(r.value)<t.minValue&&(r.value=t.minValue),this.blockedSceneTimestamp!==this.currentSceneTimestamp&&this.parent.states.setState(e,Number(r.value))})),n.appendChild(s),n.appendChild(r),this.appendToHTML(e,{element:n,label:s,value:r})}renderRangeSlider(e,t){let n=document.createElement("div");n.id=e;let s=document.createElement("span");s.innerText=t.startLabel,s.classList.add("controls__range-slider-start-label","controls__option-label");let r=document.createElement("input");r.type="range",r.min=t.minValue,r.max=t.maxValue,r.value=t.defaultValue,r.classList.add("controls__range-slider"),r.setAttribute(this.#s,this.currentSceneTimestamp),r.checked=t.state;let i=document.createElement("span");i.innerText=t.endLabel,i.classList.add("controls__range-slider-end-label","controls__option-label"),this.parent.states.setState(e,t.defaultValue),r.addEventListener("mousemove",(t=>{this.blockedSceneTimestamp!==this.currentSceneTimestamp&&(r.title=r.value,this.parent.states.setState(e,r.value))})),n.appendChild(s),n.appendChild(r),n.appendChild(i),this.appendToHTML(e,{element:n,label:[s,i],value:r})}renderButton(e,t){let n=document.createElement("div");n.id=e;let s=document.createElement("span");s.innerHTML=t.label+": ";let r=document.createElement("button");r.classList.add("controls__button"),r.setAttribute(this.#s,this.currentSceneTimestamp),r.textContent=t.text,r.addEventListener("click",(()=>{if(this.blockedSceneTimestamp!==this.currentSceneTimestamp){let t=Date.now();this.parent.states.setState(e,t)}})),n.appendChild(s),n.appendChild(r),this.appendToHTML(e,{element:n,label:s,value:r})}renderMainActionButton(e,t){let n=document.createElement("div");n.id=e;let s=document.createElement("div");s.classList.add("hr-line-separator");let r=document.createElement("button");if(r.classList.add("controls__main-action-button"),r.setAttribute(this.#r,""),r.setAttribute(this.#s,this.currentSceneTimestamp),r.textContent=t.text,r.addEventListener("click",(()=>{if(this.blockedSceneTimestamp!==this.currentSceneTimestamp){let t=Date.now();this.parent.states.setState(e,t)}})),n.appendChild(s),n.appendChild(r),!0===t.blockControlDuringExecution){let t=e+"__status";this.parent.states.setState(t,"not-started");let n=this.#i(this.currentSceneTimestamp);this.parent.states.subscribe(((e,s,r)=>{e==t&&("in-progress"==s?n.block():n.unblock())}))}this.appendToHTML(e,{element:n,label:null,value:r})}renderOptionSelector(e,t){let n=document.createElement("div");n.id=e;let s=document.createElement("span");s.classList.add("controls__option-selector-label","controls__option-label"),s.innerText=t.label+": ";let r=document.createElement("div");r.classList.add("controls__buttons-container"),t.optionNames.forEach(((t,s)=>{let i=document.createElement("button");i.classList.add("controls__option-selector-button"),i.setAttribute(this.#s,this.currentSceneTimestamp),i.textContent=t,i.setAttribute("data-preset-num",s),0==s&&i.setAttribute("data-selected-option",!0),i.addEventListener("click",(()=>{if(this.blockedSceneTimestamp!==this.currentSceneTimestamp){let t=Array.from(n.querySelectorAll('[data-selected-option="true"]'));t.length>0&&t.forEach((e=>e.removeAttribute("data-selected-option"))),i.setAttribute("data-selected-option",!0),this.parent.states.setState(e,Number(s))}})),r.appendChild(i)})),this.parent.states.setState(e,t.defaultValue),n.appendChild(s),n.appendChild(r),this.appendToHTML(e,{element:n,label:s,value:r})}renderOptionDropdownList(e,t){let n=document.createElement("div");n.id=e;let s=document.createElement("span");s.classList.add("controls__option-dropdown-list-label","controls__option-dropdown-list-label"),s.innerText=t.label+": ";let r=document.createElement("select");return r.classList.add("controls__option-dropdown-list-container"),t.options.forEach(((n,s)=>{let i=document.createElement("option");i.classList.add("controls__option-dropdown-list-button"),i.setAttribute(this.#s,this.currentSceneTimestamp),i.textContent=n.name,i.setAttribute("data-preset-num",s),t.selectedByDefault===s&&(i.setAttribute("selected",""),this.parent.states.setState(e,Number(s))),r.appendChild(i)})),r.addEventListener("change",(t=>{let n=Number(r.selectedOptions[0].getAttribute("data-preset-num"));this.parent.states.setState(e,Number(n))})),n.appendChild(s),n.appendChild(r),this.appendToHTML(e,{element:n,label:s,value:r}),n}renderPresetDropdownList(e,t){const n=this.renderOptionDropdownList(e,t).querySelector("select"),s=()=>{const s=Object.keys(this.#n),r=Number(n.selectedOptions[0].getAttribute("data-preset-num")),i=t.options[r].allowedElements;let l;if(!Array.isArray(i))throw new Error("option.allowedElements type must be an array!");l=0===i.length?s.filter((t=>t!==e&&"root"!==t)):i.includes("*")?[]:s.filter((t=>t!==e&&"root"!==t&&!i.includes(t))),s.forEach((e=>{if("root"!==e){const t=this.#n[e].element;l.includes(e)?t.classList.add("hidden"):t.classList.remove("hidden")}}))};n.addEventListener("change",s),this.parent.addEventListener("renderEnd",s)}}class r{#n;#l="scene-info__";#a="data-dynamiclly-rendered";constructor(e){this.#n={root:e}}updateValue(e,t){this.#n[e].value.innerHTML=t}clearRoot(){this.#n.root.innerHTML=""}appendToHTML(e,t){let{element:n,label:s,value:r}=t;this.#n[e]=t,this.#n.root.appendChild(n)}renderInfoBox(e,t){let n=document.createElement("div");n.id=this.#l+e,n.classList.add("display-infobox");let s=document.createElement("span");s.classList.add(this.#l+"display-infobox-label",this.#l+"item-label"),s.innerHTML="â‡¢ "+t.label;let r=document.createElement("div");r.innerText=t.text,n.appendChild(s),n.appendChild(r),this.appendToHTML(e,{element:n,label:s,value:r})}renderFormula(e){const t=(e,t=!1,n=!1)=>{let s=1,r=1,i="";if(/\//g.test(e)){const t=e.split("/"),n=e=>/(\{|\})/.test(e)?Math.abs(Number(e.replace(/(\{|\})/gm,""))):e;i=1==/\-/gm.test(t[0])?"-":"",s=n(t[0]),r=n(t[1])}else{const t=decimalToFraction(e);i=t.denominator<0?"-":"",s=t.numerator,r=Math.abs(t.denominator)}return`\n                ${i?"<span>"+i+"</span>":""}\n                <div class="math-fraction ${1==t?"math-fraction--degree-format":""}">\n                    <div class="math-fraction__numerator">${s}</div>\n                    <div class="math-fraction__denominator">${r}</div>\n                </div>\n                <span class="math-fraction__x-symbol">${1==n?"x":""}</span>\n            `};let n=e.split(/(?<![\{])([+-])/gm).map((e=>{if(!/(?<![\{])([+-])/gm.test(e)){if(/x/gm.test(e)){if(/\^/gm.test(e)){let n=e.split(/(\^)/);return n.map(((e,s)=>{if("^"==e){let e=n[s-1].replace("x",""),r="-"==e||""==e?1:e,i=n[s+1];return/\//g.test(r)&&(e=t(r)),/\//g.test(i)&&(i=t(i.replace("x",""),!0,!0)),`<span>${e}${"e"==e?"":"x"}<sup>${i}</sup></span>`}})).join("")}if(/\/\d{0,}x/g.test(e))return t(e);{let n=e.replace("x","");return/\//g.test(n)&&(n=t(n)),1==n?"x":n+"x"}}return/\//g.test(e)?t(e):""==e?"":Number(e)}return e}));e=n.join("");let s=document.createElement("span");return s.innerHTML=e,s.classList.add("math-formula"),s.outerHTML}renderSpacer(){let e=document.createElement("div");return e.classList.add("display-spacer"),this.appendToHTML("spacer",{element:e,label:e,value:null}),e}isExist(e){return void 0!==this.#n[e]}renderDisplayItem(e,t){let n=document.createElement("div");n.id=this.#l+e,n.classList.add("display-item");let s=document.createElement("span");s.classList.add(this.#l+"display-label",this.#l+"item-label"),s.innerHTML=!0===t.hideColon?t.label:t.label+": ";let r=document.createElement("span");return r.classList.add(this.#l+"display-value",this.#l+"item-value"),r.innerHTML=t.text?t.text:'<i class="pale">no info</i>',n.appendChild(s),n.appendChild(r),this.#n[e]=r,this.appendToHTML(e,{element:n,label:s,value:r}),n}renderDisplayFloatTile(e,t){let n=this.renderDisplayItem(e,t);return n.classList.remove("display-item"),n.classList.add("display-float-tile"),n}dynamicRender(e,t){let n;"display-item"==t.type&&(n=this.renderDisplayItem(e,t)),"display-float-tile"==t.type&&(n=this.renderDisplayFloatTile(e,t)),"display-spacer"==t.type&&(n=this.renderSpacer()),n&&n.setAttribute(this.#a,!0)}removeDynamicllyRendered(){Array.from(document.querySelectorAll(`[${this.#a}]`)).forEach((e=>{e.remove()}))}}window.exportedObjects=[],window.runningAnimations={queue:[],add:function(e,t=!0){1==t&&this.clearQueue(!0);const n=t=>{e(t);const s=requestAnimationFrame(n);n.id=s};n(),this.queue.push(n)},clearQueue:function(e=!1){this.queue.length>0?this.queue.forEach((e=>{window.cancelAnimationFrame(e.id),console.log(`Animation thread #${e.id} from previous scene is killed right now`)})):0==e&&console.log("All OK! Animation queue is already empty"),this.queue=[]}};class i{static#o="data-link-to-demo";static#d="data-improted-scene";static#c="#root";static#m="#scene-info";static#p="#controls";static#u="./js/scenes/";static#h="Canvas demo";constructor(){this.displayName="Page",this.windowTitle=i.#h,this.root=i.parseRoot(),this.currentScene=null,this.links=i.parseLinks()}static parseLinks(){let e=document.querySelectorAll(`[${i.#o}]`);return Array.from(e)}static parseRoot(){return document.querySelector(`${i.#c}`)}static parseUIControls(){return document.querySelector(`${i.#p}`)}static parseUIDisplay(){return document.querySelector(`${i.#m}`)}static createSciptTag(e){let t=document.createElement("script");return t.setAttribute("src",e),t.setAttribute("type","text/javascript"),t.setAttribute("async","async"),t}#b(e){this.windowTitle=i.#h+" - "+e}loadScene(e){return new Promise(((t,n)=>{if(0==window.exportedObjects.length){let e=document.createComment("imported scenes");document.body.appendChild(e)}let s=document.querySelector(`script[src="${e}"]`);if(s&&"HTMLScriptElement"==s.constructor.name){let e=s.getAttribute(i.#d),n=window.exportedObjects.find((t=>t.timestamp==Number(e)));t(n)}else s=i.createSciptTag(e),document.body.appendChild(s),s.addEventListener("load",(()=>{let e=Date.now();if(s.setAttribute(`${i.#d}`,e),window.exportedObjects&&window.exportedObjects.length>0){let n=getArrayLast(window.exportedObjects);n.timestamp=e,t(n)}else n(new Error("Object not found after script load"))})),s.addEventListener("error",(e=>{n(new Error("Error on loading file: "+e.message))}))}))}#y(){Array.isArray(this.links)&&this.links.forEach((e=>{e.addEventListener("click",(t=>{let s=e.getAttribute(i.#o),r=`${i.#u}${s}.js`;e.setAttribute("href",`#${s}`),this.loadScene(r).then((e=>{this.currentScene=e,e.ui=new n({timestamp:e.timestamp,display:i.parseUIDisplay(),controls:i.parseUIControls()}),e.ui.render(e.uiTree),this.#b(e.title),e.execute({root:this.root})})).catch((e=>{console.log(e)}))}))}))}init(){this.#y(),document.querySelectorAll("[data-link-to-demo]")[0].click()}}const l=new i;l.init(),console.log("Page loaded!"),console.log(l)})();